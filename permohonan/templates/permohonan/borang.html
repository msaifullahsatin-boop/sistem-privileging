{% extends 'permohonan/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
    <h1>Borang Permohonan Privileging</h1>
    <hr>
    <form method="post" enctype="multipart/form-data" class="mb-5">
        {% csrf_token %}
        
        <div class="card mb-4">
            <div class="card-header fw-bold">BAHAGIAN I: MAKLUMAT PEMOHON</div>
            <div class="card-body">
                {{ form_utama|crispy }}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header fw-bold">BAHAGIAN II: KELAYAKAN (Ijazah, Master dll.)</div>
            <div class="card-body">
                <div id="kelayakan-formset">
                    {{ kelayakan_formset.management_form }}
                    {% for form in kelayakan_formset %}
                        <div class="dynamic-form border-bottom pb-3 mb-3">
                            {{ form|crispy }}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header fw-bold">BAHAGIAN III: SENARAI PROSEDUR YANG DIPOHON</div>
            <div class="card-body">
                <h5 class="mt-3">Core Procedures</h5>
                <div id="core-formset">
                    {{ core_formset.management_form }}
                    {% for form in core_formset %}<div class="dynamic-form">{{ form|crispy }}</div>{% endfor %}
                </div>
                <hr>

                <h5 class="mt-4">Specialised Procedures</h5>
                <div id="specialised-formset">
                    {{ specialised_formset.management_form }}
                    {% for form in specialised_formset %}<div class="dynamic-form">{{ form|crispy }}</div>{% endfor %}
                </div>
                <hr>
                
                <h5 class="mt-4">Addition Procedures</h5>
                <p class="text-muted small">Abaikan jika tidak berkaitan.</p>
                <div id="addition-formset">
                    {{ addition_formset.management_form }}
                    {% for form in addition_formset %}<div class="dynamic-form">{{ form|crispy }}</div>{% endfor %}
                </div>
                <hr>
                
                <h5 class="mt-4">Reduction Procedures</h5>
                <p class="text-muted small">Abaikan jika tidak berkaitan.</p>
                <div id="reduction-formset">
                    {{ reduction_formset.management_form }}
                    {% for form in reduction_formset %}<div class="dynamic-form">{{ form|crispy }}</div>{% endfor %}
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg">Hantar Permohonan kepada Ketua Jabatan</button>
    </form>
{% endblock %}


{% block extra_js %}
<script type="text/javascript">
$(document).ready(function() {
    // Fungsi plugin formset
    function initializeFormset(selector, prefix, addText) {
        $(selector).formset({
            prefix: prefix,
            addText: addText,
            deleteText: 'Buang',
            addCssClass: 'btn btn-success btn-sm mt-2 add-row',
            deleteCssClass: 'btn btn-danger btn-sm mt-2 delete-row'
        });
    }

    // Laksanakan untuk setiap formset
    initializeFormset('#kelayakan-formset .dynamic-form', '{{ kelayakan_formset.prefix }}', 'Tambah Kelayakan');
    initializeFormset('#core-formset .dynamic-form', '{{ core_formset.prefix }}', 'Tambah Core Procedure');
    initializeFormset('#specialised-formset .dynamic-form', '{{ specialised_formset.prefix }}', 'Tambah Specialised Procedure');
    initializeFormset('#addition-formset .dynamic-form', '{{ addition_formset.prefix }}', 'Tambah Addition Procedure');
    initializeFormset('#reduction-formset .dynamic-form', '{{ reduction_formset.prefix }}', 'Tambah Reduction Procedure');
    
    // Skrip untuk Kategori Bersarang
    const kategoriUtama = $('#id_kategori_utama');
    const kategoriBawahanDiv = $('#div_id_kategori_bawahan');
    const jawatanLainDiv = $('#div_id_jawatan_lain');

    function toggleKategoriFields() {
        const selectedUtama = kategoriUtama.val();
        kategoriBawahanDiv.hide();
        jawatanLainDiv.hide();
        if (['Pakar Perubatan / Pergigian', 'Jururawat', 'Penolong Pegawai Perubatan', 'Juruterapi Pergigian', 'Anggota Kesihatan Bersekutu', 'Pegawai Farmasi', 'Penolong Pegawai Farmasi'].includes(selectedUtama)) {
            kategoriBawahanDiv.show();
        } else if (selectedUtama === 'Lain-lain') {
            jawatanLainDiv.show();
        }
    }
    toggleKategoriFields();
    kategoriUtama.change(toggleKategoriFields);
});
</script>
{% endblock %}